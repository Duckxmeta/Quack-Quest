import random
import time
import os

# A dictionary to define the type effectiveness.
# Key: Attacking type
# Value: Dictionary of defending types and their multipliers.
TYPE_CHART = {
    'Fire': {'Fire': 0.5, 'Water': 0.5, 'Grass': 2.0, 'Normal': 1.0},
    'Water': {'Fire': 2.0, 'Water': 0.5, 'Grass': 0.5, 'Normal': 1.0},
    'Grass': {'Fire': 0.5, 'Water': 2.0, 'Grass': 0.5, 'Normal': 1.0},
    'Normal': {'Fire': 1.0, 'Water': 1.0, 'Grass': 1.0, 'Normal': 1.0},
}

# --- Class Definitions ---

class Move:
    """Represents a single move that a Critter can use."""
    def __init__(self, name, move_type, power):
        self.name = name
        self.type = move_type
        self.power = power

class Critter:
    """Represents a single creature with stats, moves, and a type."""
    def __init__(self, name, critter_type, max_hp, attack, defense, speed, moves):
        self.name = name
        self.type = critter_type
        self.max_hp = max_hp
        self.current_hp = max_hp
        self.attack = attack
        self.defense = defense
        self.speed = speed
        self.moves = moves
        self.is_fainted = False

    def take_damage(self, damage):
        """Applies damage to the critter and checks if it has fainted."""
        self.current_hp -= damage
        if self.current_hp <= 0:
            self.current_hp = 0
            self.is_fainted = True
            print(f"{self.name} has fainted!")

    def get_hp_bar(self):
        """Returns a string representing the HP bar."""
        bar_length = 20
        filled_length = int(bar_length * self.current_hp / self.max_hp)
        bar = 'â–ˆ' * filled_length + '-' * (bar_length - filled_length)
        return f"HP: {self.current_hp}/{self.max_hp} [{bar}]"

class Player:
    """Represents a player (or AI) with a team of critters."""
    def __init__(self, name, team):
        self.name = name
        self.team = team
        self.active_critter = team[0]

    def switch_critter(self, index):
        """Switches the active critter to another one on the team."""
        if 0 <= index < len(self.team) and not self.team[index].is_fainted:
            self.active_critter = self.team[index]
            print(f"{self.name} sent out {self.active_critter.name}!")
            return True
        return False

    def has_lost(self):
        """Checks if all critters on the team have fainted."""
        return all(critter.is_fainted for critter in self.team)

# --- Helper Functions ---

def clear_screen():
    """Clears the console screen."""
    os.system('cls' if os.name == 'nt' else 'clear')

def wait(seconds=1.5):
    """Pauses the execution for a given number of seconds."""
    time.sleep(seconds)

# --- Battle Logic ---

def calculate_damage(attacker_critter, defender_critter, move):
    """Calculates the damage of an attack based on stats and types."""
    print(f"{attacker_critter.name} used {move.name}!")
    wait()

    # Get the type effectiveness multiplier
    type_multiplier = TYPE_CHART.get(move.type, {}).get(defender_critter.type, 1.0)

    if type_multiplier > 1.0:
        print("It's super effective!")
    elif type_multiplier < 1.0:
        print("It's not very effective...")
    wait()
    
    # Simple damage formula
    damage = (
        (attacker_critter.attack * move.power / defender_critter.defense) / 5
    )
    # Add some randomness
    damage *= random.uniform(0.9, 1.1)
    damage = int(damage * type_multiplier)

    return max(1, damage) # Ensure at least 1 damage is dealt

def display_battle_status(player1, player2):
    """Displays the current state of the battle."""
    clear_screen()
    print("="*40)
    print(f"OPPONENT: {player2.active_critter.name}")
    print(player2.active_critter.get_hp_bar())
    print("\n" * 2)
    print(f"PLAYER: {player1.active_critter.name}")
    print(player1.active_critter.get_hp_bar())
    print("="*40)

def get_player_choice(player):
    """Gets the player's action choice (fight or switch)."""
    while True:
        print("What will you do?")
        print("1. Fight")
        print("2. Switch Critter")
        choice = input("> ")
        if choice in ["1", "2"]:
            return choice
        print("Invalid choice. Please enter 1 or 2.")

def get_move_choice(player):
    """Gets the player's move choice."""
    while True:
        print("Choose a move:")
        for i, move in enumerate(player.active_critter.moves):
            print(f"{i + 1}. {move.name} ({move.type})")
        
        try:
            choice = int(input("> "))
            if 1 <= choice <= len(player.active_critter.moves):
                return player.active_critter.moves[choice - 1]
            else:
                print("Invalid move number.")
        except ValueError:
            print("Please enter a number.")

def get_switch_choice(player):
    """Gets the player's choice for switching critters."""
    while True:
        print("Choose a critter to switch to:")
        for i, critter in enumerate(player.team):
            status = "FAINTED" if critter.is_fainted else f"HP: {critter.current_hp}/{critter.max_hp}"
            if critter is player.active_critter:
                print(f"{i + 1}. {critter.name} ({critter.type}) - ACTIVE")
            else:
                print(f"{i + 1}. {critter.name} ({critter.type}) - {status}")
        
        try:
            choice = int(input("> "))
            if not (1 <= choice <= len(player.team)):
                print("Invalid number.")
            elif player.team[choice - 1].is_fainted:
                print(f"{player.team[choice - 1].name} is fainted and cannot fight!")
            elif player.team[choice - 1] is player.active_critter:
                print(f"{player.team[choice - 1].name} is already in battle!")
            else:
                return choice - 1
        except ValueError:
            print("Please enter a number.")


# --- Main Game Loop ---

def battle(player1, player2):
    """The main function to run a battle between two players."""
    print(f"{player1.name} challenges {player2.name} to a battle!")
    wait()

    while not player1.has_lost() and not player2.has_lost():
        # Determine turn order based on speed
        p1_turn = player1.active_critter.speed >= player2.active_critter.speed
        
        turn_order = [player1, player2] if p1_turn else [player2, player1]
        
        # Store choices before executing actions
        choices = {}

        for current_player in turn_order:
            display_battle_status(player1, player2)
            
            # --- AI Logic for Opponent ---
            if current_player == player2:
                print(f"\n{player2.name} is thinking...")
                wait()
                # Simple AI: always chooses the first move
                choices[current_player] = {'action': 'move', 'move': current_player.active_critter.moves[0]}
                continue

            # --- Human Player Logic ---
            action_choice = get_player_choice(current_player)

            if action_choice == "1": # Fight
                move = get_move_choice(current_player)
                choices[current_player] = {'action': 'move', 'move': move}
            elif action_choice == "2": # Switch
                switch_index = get_switch_choice(current_player)
                choices[current_player] = {'action': 'switch', 'index': switch_index}
        
        # Execute actions based on speed order
        for current_player in turn_order:
            opponent = player2 if current_player == player1 else player1
            
            # Skip turn if active critter fainted from the first attacker's move
            if current_player.active_critter.is_fainted:
                continue

            choice = choices[current_player]

            if choice['action'] == 'switch':
                current_player.switch_critter(choice['index'])
                wait()
            
            elif choice['action'] == 'move':
                damage = calculate_damage(current_player.active_critter, opponent.active_critter, choice['move'])
                opponent.active_critter.take_damage(damage)
                print(f"{opponent.active_critter.name} took {damage} damage!")
                wait()

                # Check if the opponent's critter fainted
                if opponent.active_critter.is_fainted:
                    display_battle_status(player1, player2)
                    wait()
                    if opponent.has_lost():
                        break # End the battle immediately
                    
                    # Force opponent to switch
                    if opponent == player1: # Human player must switch
                        print(f"{opponent.name}, you must choose a new critter.")
                        switch_index = get_switch_choice(opponent)
                        opponent.switch_critter(switch_index)
                    else: # AI switches to the next available critter
                        for i in range(len(opponent.team)):
                            if not opponent.team[i].is_fainted:
                                opponent.switch_critter(i)
                                break
                    wait()


    # --- End of Battle ---
    clear_screen()
    if player1.has_lost():
        print(f"{player2.name} wins the battle!")
    else:
        print(f"Congratulations! {player1.name} wins the battle!")


# --- Game Setup ---

if __name__ == "__main__":
    # 1. Create Moves
    tackle = Move(name="Tackle", move_type="Normal", power=10)
    scratch = Move(name="Scratch", move_type="Normal", power=9)
    ember = Move(name="Ember", move_type="Fire", power=12)
    flame_burst = Move(name="Flame Burst", move_type="Fire", power=15)
    water_gun = Move(name="Water Gun", move_type="Water", power=12)
    aqua_jet = Move(name="Aqua Jet", move_type="Water", power=14)
    vine_whip = Move(name="Vine Whip", move_type="Grass", power=12)
    razor_leaf = Move(name="Razor Leaf", move_type="Grass", power=15)

    # 2. Create Critters
    flambit = Critter(name="Flambit", critter_type="Fire", max_hp=45, attack=14, defense=10, speed=12, moves=[scratch, ember, flame_burst])
    aquafin = Critter(name="Aquafin", critter_type="Water", max_hp=50, attack=12, defense=12, speed=10, moves=[tackle, water_gun, aqua_jet])
    leafy = Critter(name="Leafy", critter_type="Grass", max_hp=55, attack=10, defense=14, speed=8, moves=[tackle, vine_whip, razor_leaf])
    stonetail = Critter(name="Stonetail", critter_type="Normal", max_hp=65, attack=15, defense=15, speed=7, moves=[tackle, scratch])

    # 3. Create Players and their Teams
    player_team = [leafy, aquafin]
    opponent_team = [flambit, stonetail]

    player = Player(name="You", team=player_team)
    opponent = Player(name="Rival Gary", team=opponent_team)
    
    # 4. Start the Battle
    battle(player, opponent)
